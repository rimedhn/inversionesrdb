<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FACTURA</title>
    <link rel="icon" href="https://github.com/rimedhn/demo/blob/main/Logo.png?raw=true" type="image/x-icon">
    <style type="text/css">
      #letter-size {
        width: 5.5in;
        margin: 0in;
        padding: 20px;
        font-family: Arial, sans-serif;
        margin-left: 0.2in;
        margin-right: 0.2in;
        margin-top: 0.5in;
        margin-bottom: 0.5in;
      }
      .label {
        text-align: center;
        font-size: 18px;
        margin-bottom: 10px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        word-break: break-word;
        white-space: normal;
        overflow-wrap: break-word;
      }
      .sin-bordes {
        border-collapse: collapse;
        border: 0px;
      }
      table, th, td {
        border: 1px solid black;
        padding: 8px;
        word-break: break-word;
        white-space: normal;
        overflow-wrap: break-word;
      }
      #detailhead .line1 { text-align: left; width: 50%; }
      .detail1 { text-align: right; width: 50%; }
      .Fact { text-align: left; }
      .listitem { font-size: 16px; text-align: left; }
      #listitemhead { font-size: 5px; text-align: center; }
      .descriptions { text-align: left; }
      #letter-size h2 { font-size: 22px; text-align: center; margin-bottom: 10px; }
      #letter-size .informasi { text-align: left; font-size: 16px; margin-bottom: 5px; }
      #letter-size .bawah { text-align: center; margin-top: 20px; font-size: 18px; }
      .mi-imagen { width: 100px; height: 100px; padding: auto; align: center; vertical-align: center; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.4/tabletop.min.js"></script>
  </head>
  <body>
    <div class="label" id="letter-size">
      <table style="width: 100%; border-collapse: collapse; border: none;" class="sin-bordes">
        <tr>
          <th colspan="3" style="width: 10%">
            <img src="https://github.com/rimedhn/demo/blob/main/Logo.png?raw=true" alt="Mi imagen" class="mi-imagen" />
          </th>
          <th colspan="9" style="width: 90%; text-align: left">
            <b style="font-size: 30px" id="Sucursal"></b><br />
            <b>RTN: <span id="RTN"></span></b><br />
            <b>Direccion: <span id="Ruta"></span></b><br />
            <b>Telefono: <span id="Caja"></span></b><br />
            <b>Email: <span id="email"></span></b>
            <b id="Tipo"></b>
          </th>
        </tr>
      </table>
      <table style="width: 100%">
        <tr>
          <th colspan="12"><b><h2 id="TipoDoc"></h2></b></th>
        </tr>
        <tr>
          <th colspan="6" style="width: 50%; white-space: nowrap">Datos cliente</th>
          <th colspan="6" style="width: 50%; white-space: nowrap">Datos factura</th>
        </tr>
        <tr>
          <td colspan="6" style="width: 50%; white-space: nowrap;">
            <div style="text-align: left">
              <b>Cliente: <span id="Cliente"></span></b><br />
              <b>RTN: <span id="RTN_cliente"></span></b><br />
              <b>Telefono: <span id="Telefono_cliente"></span></b><br />
              <b>Direccion: <span id="Direccion_cliente"></span></b><br />
              <b>Vendedor: <span id="Vendedor"></span></b><br />
            </div>
          </td>
          <td colspan="6" style="width: 50%; white-space: nowrap;">
            <div style="text-align: left">
              <b>Factura: <span id="Factura"></span></b><br />
              <b>Fecha: <span id="Fecha"></span></b><br />
              <b>CAI: <span id="CAI"></span></b><br />
              <b>Rango autorizado: <span id="RangoAutorizado"></span></b><br />
              <b>Fecha limite de emision: <span id="Vencimiento"></span></b><br />
              <b>Cajero: <span id="Caja"></span></b><br />
            </div>
          </td>
        </tr>
      </table>
      <table style="width: 100%">
        <tr>
          <td style="text-align: center;" class="detalleproducts" colspan="7">Detalle</td>
        </tr>
        <tr>
          <td style="text-align: left; width: 13%">
            <h2 style="font-size: 4mm; text-align: Center; line-height: 0.1">Referencia</h2>
          </td>
          <td style="text-align: right; width: 10%">
            <h2 style="font-size: 4mm; text-align: Center; line-height: 0.1">Cantidad</h2>
          </td>
          <td style="text-align: right; width: 10%">
            <h2 style="font-size: 4mm; text-align: Center; line-height: 0.1">Talla</h2>
          </td>
          <td style="text-align: right; width: 10%">
            <h2 style="font-size: 4mm; text-align: Center; line-height: 0.1">Color</h2>
          </td>
          <td style="text-align: left; width: 25%">
            <h2 style="font-size: 4mm; text-align: Center; line-height: 0.1">Descripcion</h2>
          </td>
          <td style="text-align: left; width: 15%">
            <h2 style="font-size: 4mm; text-align: Center; line-height: 0.1">Marca</h2>
          </td>
          <td style="text-align: right; width: 17%">
            <h2 style="font-size: 4mm; text-align: Center; line-height: 0.1">Importe</h2>
          </td>
        </tr>
        <tbody id="productList"></tbody>
      </table>
      <table style="padding: 0; border: none; border-collapse: collapse">
        <tr style="border: none; border-collapse: collapse">
          <td colspan="3" style="text-align: left; vertical-align: top; border: none; border-collapse: collapse;">
            <b>Original: cliente, Copia: emisor</b>
            <br /><span>www.rmposhn.com</span><br />
            <span>indime.hn@gmail.com</span>
            <span>(+504) 9359-3126</span>
          </td>
          <td colspan="3" style="white-space: nowrap; border: none; border-collapse: collapse">
            <div style="text-align: right">
              <img alt="Barcode Generator TEC-IT" id="barcode" />
            </div>
          </td>
        </tr>
      </table>
      <div style="text-align: center; font-weight: bold; font-size: 18px;">
        MONTO EN LETRAS: <span id="montoLetras"></span>
      </div>
    </div>
    <script>
      // Pega aquí el enlace de tu Google Sheet
      var publicSpreadsheetUrl = 'https://docs.google.com/spreadsheets/d/1VdD4AgpMbyMMCQg6LRJuFZh4LP3hC9WVFvr2UrETcEg/edit?gid=1481779244#gid=0';
      var hojaGeneral = "Ventas";
      var hojaDetalle = "Venta";

      function getQueryParam(param) {
        var urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      function init() {
        Tabletop.init({
          key: publicSpreadsheetUrl,
          callback: showInfo,
          simpleSheet: false
        });
      }

      function showInfo(data, tabletop) {
        // Se busca por "No Venta" que es el campo clave en ambas hojas
        var noVenta = getQueryParam('no_venta');
        var vg = data[hojaGeneral].elements.find(r => r["No Venta"] == noVenta);
        var productos = data[hojaDetalle].elements.filter(r => r["No Venta"] == noVenta);

        if (!vg) {
          alert("Venta no encontrada en '" + hojaGeneral + "'");
          return;
        }

        // Datos principales (ajustados a tus encabezados de Ventas)
        document.getElementById("Sucursal").textContent = vg["Sucursal"] || "";
        document.getElementById("RTN").textContent = vg["RTN"] || "";
        document.getElementById("Ruta").textContent = vg["Ruta"] || "";
        document.getElementById("Caja").textContent = vg["Caja"] || "";
        document.getElementById("email").textContent = ""; // Si tienes campo de email, ponlo aquí
        document.getElementById("Tipo").textContent = vg["Tipo"] || "";

        document.getElementById("TipoDoc").textContent = vg["Tipo"] || "";
        document.getElementById("Cliente").textContent = vg["Cliente"] || "";
        document.getElementById("RTN_cliente").textContent = vg["RTN"] || "";
        document.getElementById("Telefono_cliente").textContent = vg["Caja"] || "";
        document.getElementById("Direccion_cliente").textContent = vg["Ruta"] || "";
        document.getElementById("Vendedor").textContent = vg["Vendedor"] || "";

        document.getElementById("Factura").textContent = vg["Factura"] || vg["No Venta"] || "";
        document.getElementById("Fecha").textContent = vg["Fecha"] || "";
        document.getElementById("CAI").textContent = vg["CAI"] || "";
        document.getElementById("RangoAutorizado").textContent = (vg["Rango inicial"] || "") + " - " + (vg["Rango final"] || "");
        document.getElementById("Vencimiento").textContent = vg["Vencimiento"] || "";

        // Código de barras
        document.getElementById("barcode").src =
          "https://barcode.tec-it.com/barcode.ashx?data=" + (vg["Factura"] || vg["No Venta"]);

        // Detalle productos: Referencia (Producto), Cantidad, Talla, Color, Descripcion, Marca, Importe
        var productList = document.getElementById("productList");
        productList.innerHTML = "";
        var montoTotal = 0;
        productos.forEach(function(p) {
          var rowHTML = productList.insertRow();
          rowHTML.insertCell(0).textContent = p["Producto"] || ""; // Referencia
          rowHTML.insertCell(1).textContent = p["Cantidad"] || "";
          rowHTML.insertCell(2).textContent = p["Talla"] || "";
          rowHTML.insertCell(3).textContent = p["Color"] || "";
          rowHTML.insertCell(4).textContent = p["Descripcion"] || "";
          rowHTML.insertCell(5).textContent = p["Marca"] || "";

          // Importe = cantidad * precio
          var cantidad = parseFloat(p["Cantidad"]) || 0;
          var precio = parseFloat(p["Precio"]) || 0;
          var importe = cantidad * precio;
          rowHTML.insertCell(6).textContent = importe.toFixed(2);
          montoTotal += importe;
        });

        // Monto en letras (es la suma de los importes)
        var words = numberToWords(montoTotal);
        document.getElementById("montoLetras").textContent = words;

        window.print();
      }

      // Función para convertir número a letras (simplificada)
      function numberToWords(number) {
        var units = [
          "",
          "UN ",
          "DOS ",
          "TRES ",
          "CUATRO ",
          "CINCO ",
          "SEIS ",
          "SIETE ",
          "OCHO ",
          "NUEVE ",
          "DIEZ ",
          "ONCE ",
          "DOCE ",
          "TRECE ",
          "CATORCE ",
          "QUINCE ",
          "DIECISEIS ",
          "DIECISIETE ",
          "DIECIOCHO ",
          "DIECINUEVE ",
        ];
        var tens = [
          "",
          "",
          "VEINTE ",
          "TREINTA ",
          "CUARENTA ",
          "CINCUENTA ",
          "SESENTA ",
          "SETENTA ",
          "OCHENTA ",
          "NOVENTA ",
        ];
        var hundreds = [
          "",
          "CIENTO ",
          "DOSCIENTOS ",
          "TRESCIENTOS ",
          "CUATROCIENTOS ",
          "QUINIENTOS ",
          "SEISCIENTOS ",
          "SETECIENTOS ",
          "OCHOCIENTOS ",
          "NOVECIENTOS ",
        ];
        var scales = ["", "MIL ", "MILLON ", "MIL MILLONES ", "BILLON "];

        if (!number || isNaN(number)) return "CERO LEMPIRAS";

        number = Math.floor(number);
        var words = "";
        var scaleIndex = 0;

        while (number > 0) {
          if (number % 1000 !== 0) {
            var scale = scales[scaleIndex];
            var partWords = numberToWordsLessThanThousand(number % 1000);

            if (scaleIndex === 1 && number % 1000 === 1) {
              words = scale + words;
            } else {
              words = partWords + scale + words;
            }
          }
          number = Math.floor(number / 1000);
          scaleIndex++;
        }

        return words.trim() + " LEMPIRAS";

        function numberToWordsLessThanThousand(n) {
          var words = "";

          if (n >= 100) {
            if (n === 100) {
              words += "CIEN ";
            } else {
              words += hundreds[Math.floor(n / 100)];
            }
            n %= 100;
          }

          if (n >= 20) {
            words += tens[Math.floor(n / 10)];
            if (n % 10 !== 0) {
              if (Math.floor(n / 10) === 2) {
                words = words.slice(0, -1);
                words += "I";
              } else {
                words += "Y ";
              }
              words += units[n % 10];
            }
          } else if (n >= 1) {
            words += units[n];
          }

          return words;
        }
      }

      window.onload = function () { init(); };
    </script>
  </body>
</html>
