<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FACTURA</title>
    <link rel="icon" href="https://github.com/rimedhn/demo/blob/main/Logo.png?raw=true" type="image/x-icon">
    <style type="text/css">
      /* ...Tus estilos originales... */
      #letter-size {
        width: 5.5in;
        margin: 0in;
        padding: 20px;
        font-family: Arial, sans-serif;
        margin-left: 0.2in;
        margin-right: 0.2in;
        margin-top: 0.5in;
        margin-bottom: 0.5in;
      }
      .label {
        text-align: center;
        font-size: 18px;
        margin-bottom: 10px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        word-break: break-word;
        white-space: normal;
        overflow-wrap: break-word;
      }
      .sin-bordes {
        border-collapse: collapse;
        border: 0px;
      }
      table, th, td {
        border: 1px solid black;
        padding: 8px;
        word-break: break-word;
        white-space: normal;
        overflow-wrap: break-word;
      }
      #detailhead .line1 { text-align: left; width: 50%; }
      .detail1 { text-align: right; width: 50%; }
      .Fact { text-align: left; }
      .listitem { font-size: 16px; text-align: left; }
      #listitemhead { font-size: 5px; text-align: center; }
      .descriptions { text-align: left; }
      #letter-size h2 { font-size: 22px; text-align: center; margin-bottom: 10px; }
      #letter-size .informasi { text-align: left; font-size: 16px; margin-bottom: 5px; }
      #letter-size .bawah { text-align: center; margin-top: 20px; font-size: 18px; }
      .mi-imagen { width: 100px; height: 100px; padding: auto; align: center; vertical-align: center; }
      .resumen td { border: none !important; padding: 2px 8px !important; font-size: 16px;}
      .total-line { font-weight: bold; font-size: 18px;}
    </style>
  </head>
  <body>
    <div class="label" id="letter-size">
      <!-- ... Encabezado y tablas principales ... -->
      <table style="width: 100%; border-collapse: collapse; border: none;" class="sin-bordes">
        <tr>
          <th colspan="3" style="width: 10%">
            <img src="https://github.com/rimedhn/demo/blob/main/Logo.png?raw=true" alt="Mi imagen" class="mi-imagen" />
          </th>
          <th colspan="9" style="width: 90%; text-align: left">
            <b style="font-size: 30px" id="Sucursal"></b><br />
            <b>RTN: <span id="RTN"></span></b><br />
            <b>Direccion: <span id="Ruta"></span></b><br />
            <b>Telefono: <span id="Telefono"></span></b><br />
            <b>Email: <span id="email"></span></b>
            <b id="Tipo"></b>
          </th>
        </tr>
      </table>
      <table style="width: 100%">
        <tr>
          <th colspan="12"><b><h2 id="TipoDoc"></h2></b></th>
        </tr>
        <tr>
          <th colspan="6" style="width: 50%; white-space: nowrap">Datos cliente</th>
          <th colspan="6" style="width: 50%; white-space: nowrap">Datos factura</th>
        </tr>
        <tr>
          <td colspan="6" style="width: 50%; white-space: nowrap;">
            <div style="text-align: left">
              <b>Cliente: <span id="Cliente"></span></b><br />
              <b>RTN: <span id="RTN_cliente"></span></b><br />
              <b>Telefono: <span id="Telefono_cliente"></span></b><br />
              <b>Direccion: <span id="Direccion_cliente"></span></b><br />
              <b>Vendedor: <span id="Vendedor"></span></b><br />
            </div>
          </td>
          <td colspan="6" style="width: 50%; white-space: nowrap;">
            <div style="text-align: left">
              <b>Factura: <span id="Factura"></span></b><br />
              <b>Fecha: <span id="Fecha"></span></b><br />
              <b>CAI: <span id="CAI"></span></b><br />
              <b>Rango autorizado: <span id="RangoAutorizado"></span></b><br />
              <b>Fecha limite de emision: <span id="Vencimiento"></span></b><br />
              <b>Cajero: <span id="Caja"></span></b><br />
            </div>
          </td>
        </tr>
      </table>
      <table style="width: 100%">
        <tr>
          <td style="text-align: center;" class="detalleproducts" colspan="7">Detalle</td>
        </tr>
        <tr>
          <td style="text-align: left; width: 13%">Referencia</td>
          <td style="text-align: right; width: 10%">Cantidad</td>
          <td style="text-align: right; width: 10%">Talla</td>
          <td style="text-align: right; width: 10%">Color</td>
          <td style="text-align: left; width: 25%">Descripcion</td>
          <td style="text-align: left; width: 15%">Marca</td>
          <td style="text-align: right; width: 17%">Importe</td>
        </tr>
        <tbody id="productList"></tbody>
      </table>
      <!-- Resumen de totales -->
      <table class="resumen" style="width: 100%; margin-bottom: 10px;">
        <tr>
          <td style="text-align:right;">Subtotal</td>
          <td style="text-align:right;"><span id="subtotal"></span></td>
        </tr>
        <tr>
          <td style="text-align:right;">Impuesto (ISV)</td>
          <td style="text-align:right;"><span id="isv"></span></td>
        </tr>
        <tr>
          <td style="text-align:right;" class="total-line">Total</td>
          <td style="text-align:right;" class="total-line"><span id="total"></span></td>
        </tr>
      </table>
      <table style="padding: 0; border: none; border-collapse: collapse">
        <tr style="border: none; border-collapse: collapse">
          <td colspan="3" style="text-align: left; vertical-align: top; border: none; border-collapse: collapse;">
            <b>Original: cliente, Copia: emisor</b>
            <br /><span>www.rmposhn.com</span><br />
            <span>indime.hn@gmail.com</span>
            <span>(+504) 9359-3126</span>
          </td>
          <td colspan="3" style="white-space: nowrap; border: none; border-collapse: collapse">
            <div style="text-align: right">
              <img alt="Barcode Generator TEC-IT" id="barcode" />
            </div>
          </td>
        </tr>
      </table>
      <div style="text-align: center; font-weight: bold; font-size: 18px;">
        MONTO EN LETRAS: <span id="montoLetras"></span>
      </div>
    </div>
    <script>
      // URL de opensheet
      var opensheetUrlGeneral = "https://opensheet.elk.sh/1VdD4AgpMbyMMCQg6LRJuFZh4LP3hC9WVFvr2UrETcEg/Ventas";
      var opensheetUrlDetalle = "https://opensheet.elk.sh/1VdD4AgpMbyMMCQg6LRJuFZh4LP3hC9WVFvr2UrETcEg/Venta";
      function getQueryParam(param) {
        var urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      function fetchJSON(url) {
        return fetch(url).then(resp => resp.json());
      }

      function loadFactura() {
        var noVenta = getQueryParam('no_venta');
        if (!noVenta) {
          alert("Parámetro no_venta faltante en la URL");
          return;
        }

        Promise.all([
          fetchJSON(opensheetUrlGeneral),
          fetchJSON(opensheetUrlDetalle)
        ])
        .then(([ventas, detalles]) => {
          var vg = ventas.find(r => r["No Venta"] == noVenta);
          var productos = detalles.filter(r => r["No Venta"] == noVenta);

          if (!vg) {
            alert("Venta no encontrada en 'Ventas'");
            return;
          }

          // Encabezado principal
          document.getElementById("Sucursal").textContent = vg["Sucursal"] || "";
          document.getElementById("RTN").textContent = vg["RTN"] || "";
          document.getElementById("Ruta").textContent = vg["Ruta"] || "";
          document.getElementById("Telefono").textContent = vg["Telefono"] || vg["Caja"] || "";
          document.getElementById("email").textContent = vg["Email"] || "";
          document.getElementById("Tipo").textContent = vg["Tipo"] || "";

          document.getElementById("TipoDoc").textContent = vg["Tipo"] || "";
          document.getElementById("Cliente").textContent = vg["Cliente"] || "";
          document.getElementById("RTN_cliente").textContent = vg["RTN Cliente"] || vg["RTN"] || "";
          document.getElementById("Telefono_cliente").textContent = vg["Telefono Cliente"] || vg["Caja"] || "";
          document.getElementById("Direccion_cliente").textContent = vg["Direccion Cliente"] || vg["Ruta"] || "";
          document.getElementById("Vendedor").textContent = vg["Vendedor"] || "";

          document.getElementById("Factura").textContent = vg["Factura"] || vg["No Venta"] || "";
          document.getElementById("Fecha").textContent = vg["Fecha"] || "";
          document.getElementById("CAI").textContent = vg["CAI"] || "";
          document.getElementById("RangoAutorizado").textContent = (vg["Rango inicial"] || "") + " - " + (vg["Rango final"] || "");
          document.getElementById("Vencimiento").textContent = vg["Vencimiento"] || "";
          document.getElementById("Caja").textContent = vg["Caja"] || "";

          // Código de barras
          document.getElementById("barcode").src =
            "https://barcode.tec-it.com/barcode.ashx?data=" + encodeURIComponent(vg["Factura"] || vg["No Venta"]);

          // Detalle productos y cálculo de totales
          var productList = document.getElementById("productList");
          productList.innerHTML = "";
          var subtotal = 0;
          var isv = 0;
          var ISV_PORC = 0.15; // Porcentaje de ISV, ajusta si tu hoja tiene tasa diferente

          productos.forEach(function(p) {
            var rowHTML = productList.insertRow();
            rowHTML.insertCell(0).textContent = p["Producto"] || ""; // Referencia
            var cantidad = parseFloat(p["Cantidad"]) || 0;
            rowHTML.insertCell(1).textContent = cantidad;
            rowHTML.insertCell(2).textContent = p["Talla"] || "";
            rowHTML.insertCell(3).textContent = p["Color"] || "";
            rowHTML.insertCell(4).textContent = p["Descripcion"] || "";
            rowHTML.insertCell(5).textContent = p["Marca"] || "";

            var precio = parseFloat(p["Precio"]) || 0;
            var importe = cantidad * precio;
            rowHTML.insertCell(6).textContent = importe.toFixed(2);

            subtotal += importe;
            // Si cada producto tiene campo "ISV" úsalo, si no aplica el general
            if (p["ISV"] && !isNaN(parseFloat(p["ISV"]))) {
              isv += parseFloat(p["ISV"]);
            }
          });

          // Si no hay ISV por producto, calcula sobre el subtotal
          if (isv === 0) {
            isv = +(subtotal * ISV_PORC).toFixed(2);
          }
          var total = +(subtotal + isv).toFixed(2);

          document.getElementById("subtotal").textContent = subtotal.toFixed(2);
          document.getElementById("isv").textContent = isv.toFixed(2);
          document.getElementById("total").textContent = total.toFixed(2);

          // Monto en letras
          var words = numberToWords(total);
          document.getElementById("montoLetras").textContent = words;

          window.print();
        })
        .catch(err => {
          alert("Error al cargar datos: " + err);
        });
      }

      // Simplificada: convierte entero a letras en español
      function numberToWords(number) {
        const unidades = ["", "UN", "DOS", "TRES", "CUATRO", "CINCO", "SEIS", "SIETE", "OCHO", "NUEVE", "DIEZ", "ONCE", "DOCE", "TRECE", "CATORCE", "QUINCE", "DIECISÉIS", "DIECISIETE", "DIECIOCHO", "DIECINUEVE"];
        const decenas = ["", "", "VEINTE", "TREINTA", "CUARENTA", "CINCUENTA", "SESENTA", "SETENTA", "OCHENTA", "NOVENTA"];
        const centenas = ["", "CIENTO", "DOSCIENTOS", "TRESCIENTOS", "CUATROCIENTOS", "QUINIENTOS", "SEISCIENTOS", "SETECIENTOS", "OCHOCIENTOS", "NOVECIENTOS"];
        if (!number || isNaN(number)) return "CERO LEMPIRAS";
        let partes = number.toFixed(2).split(".");
        let entero = parseInt(partes[0]);
        let decimal = partes[1];

        let letras = "";
        if (entero === 0) {
          letras = "CERO";
        } else if (entero === 100) {
          letras = "CIEN";
        } else {
          let n = entero;
          let c = Math.floor(n / 100);
          let d = Math.floor((n % 100) / 10);
          let u = n % 10;
          if (c > 0) letras += centenas[c] + " ";
          if (d > 1) {
            letras += decenas[d];
            if (u > 0) letras += " Y " + unidades[u];
          } else if (d === 1) {
            letras += unidades[10 + u];
          } else if (u > 0) {
            letras += unidades[u];
          }
        }
        return letras.trim() + " LEMPIRAS CON " + decimal + "/100";
      }

      window.onload = loadFactura;
    </script>
  </body>
</html>
